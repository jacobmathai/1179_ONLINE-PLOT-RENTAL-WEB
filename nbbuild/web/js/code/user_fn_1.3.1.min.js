/* 
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

$(document).ready(function() {
    $('div#emp_output').hide();
    // bind send message here
    $('#userForm #regBtn').click(doRegister);

// $("#username").keyup(function(event) {
// if (event.keyCode == '13') {
// isUserExist();
// }
// });
});

/* Contact Form */
function checkEmail(email) {
    var check = /^[\w\.\+-]{1,}\@([\da-zA-Z-]{1,}\.){1,}[\da-zA-Z-]{2,6}$/;
    if (!check.test(email)) {
        return false;
    }
    return true;
}

function IsMobileNumber(phone) {
    var filter = /^((\+[1-9]{1,4}[ \-]*)|(\([0-9]{2,3}\)[ \-]*)|([0-9]{2,4})[ \-]*)*?[0-9]{3,4}?[ \-]*[0-9]{3,4}?$/;
    if (!filter.test(phone) || phone.length != 10) {
        return false;
    } else {
        return true;
    }
}

function isIMEI(imei) {
    var filter = /^((\+[1-9]{1,4}[ \-]*)|(\([0-9]{2,3}\)[ \-]*)|([0-9]{2,4})[ \-]*)*?[0-9]{3,4}?[ \-]*[0-9]{3,4}?$/;
    if (!filter.test(imei) || imei.length != 16) {
        return false;
    } else {
        return true;
    }
}
function checkPassword(pswd) {
    // at least one number, one lowercase and one uppercase letter
    // at least six characters
    var filter = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{6,20}$/;
    if (!filter.test(pswd)) {
        // alert('Wrong...!');
        return false;
    } else {
        // alert('Correct, try another...');
        return true;
    }
}

function checkUrl(url) {
    var filter = /^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/i;
    if (!filter.test(url)) {
        // alert('Wrong...!');
        return false;
    } else {
        // alert('Correct, try another...');
        return true;
    }
}
function checkTime(time) {
    var filter = /^(\d{1,2}):(\d{2})([ap]m)?$/;
    if (!filter.test(time)) {
        // alert('Wrong...!');
        return false;
    } else {
        // alert('Correct, try another...');
        return true;
    }
}

function maxLength(str) {
    if (str.length < 5) {
        return false;
    } else {
        return true;
    }
}
function isNumber(evt) { // Function for entering only digits to the year
    // input text
    evt = (evt) ? evt : window.event;
    var charCode = (evt.which) ? evt.which : evt.keyCode;
    // alert(charCode);
    if (charCode > 31 && (charCode < 48 || charCode > 57) && (charCode != 46)
        && (charCode < 95 || charCode > 105)
        && (charCode < 37 || charCode > 40)) {
        return false;
    }
    return true;
}

function isLetters(evt) {
    evt = (evt) ? evt : window.event;
    var charCode = (evt.which) ? evt.which : evt.keyCode;

    if (charCode > 32 && (charCode < 37 || charCode > 40)
        && (charCode < 46 || charCode > 46)
        && (charCode < 65 || charCode > 90) && (charCode != 190)) {
        return false;
    }
    return true;
}

function isDigit(str){
    if(isNaN(str)){
        return false;
    }
    return true;
}
function isUserExist(username) {

    var result = dhtmlxAjax.getSync('RemoteUsernameServlet?username=' + username);
    var status = result.xmlDoc.responseText;
    //alert(status);
	
    if(status.trim() == "true"){
        return true;
    } else {
        return false;
    }
	
//	$.ajax({
//				url : 'RemoteUsernameServlet',
//				type : 'post',
//				data : {"username" : username},
//				success : function(result) {
//
//					if (result.trim() == "true") { 
//						//alert(typeof(result) + " " + result);
//						$("div#emp_output")
//								.show()
//								.html(
//										"<button type=\"button\" class=\"close\" data-dismiss=\"alert\">x</button><p>The given username already exist.</p>");
//						return true;
//					} else { //
//						$('div#emp_output').hide();
//						return false;
//					}
//				}
//			});
//
//	return false;

}

function doRegister() {

    // receive the provided data
    var name = $("#userForm input#name").val();
    var username = $("#userForm input#username").val();
    var password = $("#userForm input#password").val();
    var phone = $("#userForm input#phone").val();
    var email = $("#userForm input#email").val();
    var city = $("#userForm input#city").val();

    $('div#emp_output').hide();

    //	alert("Name: " + name + " Username: " + username + " Password: " + password
    //			+ " Phone: " + phone + " Email: " + email + " City: " + city);
    // check if all the fields are filled
    if (name == '' || username == '' || password == '' || phone == ''
        || email == '' || city == '') {
        $("div#emp_output")
        .show()
        .html(
            '<button type="button" class="close" data-dismiss=\"alert\">x</button><p>You must enter all the fields!</p>');
    // return false;
    } else {
        if (isUserExist(username)) {
            $("div#emp_output")
            .show()
            .html(
                "<button type=\"button\" class=\"close\" data-dismiss=\"alert\">x</button><p>The given username already exist.</p>");
            return false;
        } else if (!checkPassword(password)) {
            //alert("check password");
            $("div#emp_output")
            .show()
            .html(
                '<button type="button" class="close" data-dismiss="alert">x</button><p>Pswd must contain digits, upper&lower case.</p>');
            return false;
        } else if (!IsMobileNumber(phone)) {
            // alert("Mobile number is not valid: " + phone);
            $("div#emp_output")
            .show()
            .html(
                '<button type="button" class="close" data-dismiss="alert">x</button><p>Please enter a valid Mobile Number</p>');
            return false;
        } else if (!checkEmail(email)) {
            $("div#emp_output")
            .show()
            .html(
                '<button type="button" class="close" data-dismiss="alert">x</button><p>Please enter a valid Email Address</p>');
            return false;
        } else if (!maxLength(city)) {
            $("div#emp_output")
            .show()
            .html(
                '<button type="button" class="close" data-dismiss="alert">x</button><p>Please enter atleast 5 letter City A</p>');
            return false;
        } else {

            var regJson = new Object();
            regJson.name = name;
            regJson.username = username;
            regJson.password = password;
            regJson.phone = phone;
            regJson.email = email;
            regJson.city = city;

            var jsonData = JSON.stringify(regJson);
            $.getJSON(
                "RegistrationJsonServlet",
                {
                    action : "export",
                    json : jsonData
                },
                function(result) {
                    if (result.message == "true") {
                        var newNode = '<div id="msg" class="notification success closeable"> <p> <span style="padding-right: 10px;"> '
                        + 'Success!</span> User added successfully. </p></div>';
                        $("#msg_label").show().html(newNode);

                        doClear();
									
                        setTimeout(function() {
                            $("#msg_label").fadeOut(1500);
                        }, 5000);
                    } else {
                        var newNode = '<div id="msg" class="notification error closeable"> <p> <span style="padding-right: 10px;"> '
                        + 'Error!</span>Failed to add account. </p></div>';
                        document.getElementById('msg_label').innerHTML = newNode;
                    }
                });
        }
        return false;

    }
	
    function doClear() {
        document.getElementById('name').value = "";
        document.getElementById('username').value = "";
        document.getElementById('password').value = "";
        document.getElementById('phone').value = "";
        document.getElementById('email').value = "";
        document.getElementById('city').value = "";
    }
    
    
    
}
